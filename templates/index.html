<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>DocuMentor ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body { margin: 0; padding: 0; background-color: #f8f9fa; }
    .hidden { display: none; }
    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    #login-section {
      max-width: 400px; margin: 100px auto;
      background: #fff; padding: 20px;
      border-radius: 6px; box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
    #env-sidebar, #user-sidebar {
      width: 220px; position: fixed; top: 0; left: 0; height: 100vh;
      background-color: #343a40; color: #fff; padding-top: 20px; overflow-y: auto;
    }
    #env-sidebar a, #user-sidebar a {
      display: block; padding: 10px 15px; color: #fff;
      text-decoration: none; cursor: pointer;
    }
    #env-sidebar a:hover, #user-sidebar a:hover { background-color: #495057; }
    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    #env-main-content, #user-main-content { margin-left: 240px; padding: 20px; }
    .section { margin-bottom: 30px; }
    .table th, .table td { vertical-align: middle; }
    #video-preview { width: 100%; max-height: 400px; margin-bottom: 10px; }
    #captured-frames .capture-item { position: relative; display: inline-block; margin: 5px; }
    #captured-frames .capture-item img { max-width: 200px; max-height: 150px; }
    #captured-frames .delete-capture {
      position: absolute; top: 0; right: 0;
      background: rgba(255, 0, 0, 0.7); color: #fff;
      border: none; cursor: pointer; padding: 2px 5px;
    }
    #captured-frames {
      border: 2px dashed #ccc;
      padding: 10px;
      min-height: 100px;
    }
    /* ç”Ÿæˆå†…å®¹ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã—ãŸã‚‰ç”»åƒã‚’Base64åŸ‹ã‚è¾¼ã¿ã™ã‚‹ */
    #generated-content {
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
  <div id="login-section">
    <h2 class="text-center">ãƒ­ã‚°ã‚¤ãƒ³</h2>
    <form id="login-form">
      <div class="form-group">
        <label for="login-username">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
        <input type="text" class="form-control" id="login-username" required>
      </div>
      <div class="form-group">
        <label for="login-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" class="form-control" id="login-password" required>
      </div>
      <button type="submit" class="btn btn-primary btn-block">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </form>
    <div id="login-result" class="mt-3 text-danger text-center"></div>
  </div>

  <!-- ENVãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
  <div id="env-app-section" class="hidden">
    <div id="env-sidebar">
      <h4 class="text-center">ENVãƒ¡ãƒ‹ãƒ¥ãƒ¼</h4>
      <a id="nav-company-management">ä¼æ¥­ç®¡ç†</a>
      <!-- é€šçŸ¥ä¸€è¦§ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤ -->
      <!-- <a id="nav-notifications">é€šçŸ¥ä¸€è¦§</a> -->
      <a id="env-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
    </div>
    <div id="env-main-content">
      <div id="section-company-management" class="section">
        <h2>ä¼æ¥­ç®¡ç†</h2>
        <div id="company-add-section" class="mb-4">
          <h4>æ–°è¦ä¼æ¥­è¿½åŠ </h4>
          <form id="company-add-form">
            <div class="form-group">
              <label for="company-name">ä¼æ¥­å</label>
              <input type="text" class="form-control" id="company-name" required>
            </div>
            <button type="submit" class="btn btn-primary">ä¼æ¥­ã‚’è¿½åŠ </button>
          </form>
        </div>
        <div id="company-list-section">
          <h4>ç™»éŒ²æ¸ˆã¿ä¼æ¥­ä¸€è¦§</h4>
          <button id="load-companies-btn" class="btn btn-secondary mb-2">ä¼æ¥­ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿</button>
          <table class="table table-bordered" id="company-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>ä¼æ¥­å</th>
                <th>ä¼æ¥­ã‚³ãƒ¼ãƒ‰</th>
                <th>ç™»éŒ²æ—¥æ™‚</th>
                <th>ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³çµ‚äº†æ—¥</th>
                <th>æ“ä½œ</th> <!-- æ“ä½œã‚«ãƒ©ãƒ  -->
              </tr>
            </thead>
            <tbody id="company-table-body"></tbody>
          </table>
        </div>
      </div>

      <!-- ENVãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘é€šçŸ¥ä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ (ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ã¯å‰Šé™¤) -->
      <div id="section-notifications" class="section hidden">
        <h3>é€šçŸ¥ä¸€è¦§</h3>
        <button id="load-notifications-btn" class="btn btn-secondary mb-2">é€šçŸ¥ã‚’èª­ã¿è¾¼ã¿</button>
        <div class="mb-3">
          <h4>è‡ªåˆ†å®›ã®é€šçŸ¥</h4>
          <table class="table table-bordered" id="notifications-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</th>
                <th>æ—¥æ™‚</th>
                <th>æ—¢èª­çŠ¶æ…‹</th>
              </tr>
            </thead>
            <tbody id="notifications-table-body"></tbody>
          </table>
        </div>
        <div>
          <h4>æ¤œç´¢ãƒ­ã‚°</h4>
          <table class="table table-bordered" id="search-logs-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                <th>æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</th>
                <th>ãƒ’ãƒƒãƒˆä»¶æ•°</th>
                <th>æ¤œç´¢æ—¥æ™‚</th>
              </tr>
            </thead>
            <tbody id="search-logs-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
  <div id="user-app-section" class="hidden">
    <div id="user-sidebar">
      <h4 class="text-center">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h4>
      <!-- â˜… ä¼æ¥­å(ä¼æ¥­ã‚³ãƒ¼ãƒ‰)ã‚’è¡¨ç¤ºã™ã‚‹é ˜åŸŸ -->
      <div id="user-company-info" class="text-center mb-2"></div>

      <a id="nav-user-upload">å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</a>
      <a id="nav-line-users">LINEãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</a>
      <a id="nav-documents">PDFç®¡ç†</a>
      <!-- é€šçŸ¥ä¸€è¦§ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤ -->
      <!-- <a id="nav-notifications-user">é€šçŸ¥ä¸€è¦§</a> -->
      <!-- PDFæ¤œç´¢ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤ -->
      <!-- <a id="nav-search">PDFæ¤œç´¢</a> -->
      <a id="nav-account">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†</a>
      <a id="user-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
    </div>
    <div id="user-main-content">
      <!-- å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div id="section-upload" class="section">
        <h3>å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
        <form id="video-upload-form" enctype="multipart/form-data">
          <div class="form-group">
            <label>ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰é¸æŠ</label>
            <div>
              <label class="radio-inline"><input type="radio" name="generation_mode" value="manual" checked> ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ç”Ÿæˆ</label>
              <label class="radio-inline"><input type="radio" name="generation_mode" value="minutes"> è­°äº‹éŒ²ç”Ÿæˆ</label>
            </div>
          </div>
          <div class="form-group">
            <label for="video-file">å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«</label>
            <input type="file" class="form-control-file" id="video-file" name="video_file" accept="video/*" required>
          </div>
          <div class="form-group">
            <label>å‹•ç”»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</label>
            <video id="video-preview" controls class="mb-2"></video>
            <button type="button" id="capture-btn" class="btn btn-secondary btn-sm">ã‚­ãƒ£ãƒ—ãƒãƒ£</button>
          </div>
          <div id="captured-frames" class="mb-3">
            <p class="text-center">ã“ã“ã«ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„</p>
          </div>
          <button type="submit" class="btn btn-primary">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
        </form>
        <div id="upload-result" class="mt-3"></div>
        <div id="generation-results" class="mt-5 hidden">
          <h4>ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„</h4>
          <div class="form-group">
            <label for="generated-content">ç”Ÿæˆå†…å®¹ï¼ˆç·¨é›†å¯èƒ½; ç”»åƒãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å¯ï¼‰</label>
            <textarea id="generated-content" class="form-control" rows="10"></textarea>
          </div>
          <button id="pdf-convert-btn" class="btn btn-success">PDFåŒ–ã—ã¦å…¬é–‹PDFç®¡ç†ã«è¿½åŠ </button>
        </div>
      </div>

      <!-- LINEãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div id="section-line-users" class="section hidden">
        <h3>LINEãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h3>
        <button id="load-line-users-btn" class="btn btn-secondary mb-2">LINEãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿</button>
        <table class="table table-bordered" id="line-users-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>è¡¨ç¤ºå</th>
              <th>éƒ¨ç½²</th>
              <th>ãƒ–ãƒ­ãƒƒã‚¯çŠ¶æ…‹</th>
              <th>ç™»éŒ²æ—¥æ™‚</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="line-users-table-body"></tbody>
        </table>
      </div>

      <!-- PDFç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div id="section-documents" class="section hidden">
        <h3>PDFç®¡ç†</h3>
        <div id="document-upload-section" class="mb-4">
          <h4>æ–°è¦PDFã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h4>
          <form id="document-upload-form" enctype="multipart/form-data">
            <div class="form-group">
              <label for="document-title">ã‚¿ã‚¤ãƒˆãƒ«</label>
              <input type="text" class="form-control" id="document-title" name="title" required>
            </div>
            <div class="form-group">
              <label for="document-category">ã‚«ãƒ†ã‚´ãƒª</label>
              <select class="form-control" id="document-category" name="category" required>
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                <option value="ãƒãƒ‹ãƒ¥ã‚¢ãƒ«">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</option>
                <option value="ç¤¾å†…è¦å®š">ç¤¾å†…è¦å®š</option>
                <option value="è­°äº‹éŒ²">è­°äº‹éŒ²</option>
              </select>
            </div>
            <div class="form-group">
              <label for="document-file">PDFãƒ•ã‚¡ã‚¤ãƒ«</label>
              <input type="file" class="form-control-file" id="document-file" name="document_file" required>
            </div>
            <button type="submit" class="btn btn-primary">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
          </form>
          <div id="doc-upload-result" class="mt-2"></div>
        </div>

        <div id="document-search-section" class="mb-4">
          <h4>PDFçµã‚Šè¾¼ã¿</h4>
          <div class="form-group">
            <input type="text" id="search-keyword" class="form-control" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚„ã‚«ãƒ†ã‚´ãƒªã§çµã‚Šè¾¼ã¿ (å…¥åŠ›ä¸­ã«å³æ™‚åæ˜ )">
          </div>
        </div>

        <div id="document-list-section">
          <h4>ç™»éŒ²æ¸ˆã¿PDFä¸€è¦§</h4>
          <button id="load-documents-btn" class="btn btn-secondary mb-2">PDFä¸€è¦§ã‚’èª­ã¿è¾¼ã¿</button>
          <table class="table table-bordered" id="documents-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
                <th>ã‚«ãƒ†ã‚´ãƒª</th>
                <th>ç™»éŒ²æ—¥æ™‚</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="documents-table-body"></tbody>
          </table>
        </div>
      </div>

      <!-- é€šçŸ¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨, ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ã¯å‰Šé™¤ï¼‰ -->
      <div id="section-notifications-user" class="section hidden">
        <h3>é€šçŸ¥ä¸€è¦§</h3>
        <button id="load-notifications-btn-user" class="btn btn-secondary mb-2">é€šçŸ¥ã‚’èª­ã¿è¾¼ã‚€</button>
        <div>
          <h4>è‡ªåˆ†å®›ã®é€šçŸ¥</h4>
          <table class="table table-bordered" id="notifications-table-user">
            <thead>
              <tr>
                <th>ID</th>
                <th>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</th>
                <th>æ—¥æ™‚</th>
                <th>æ—¢èª­çŠ¶æ…‹</th>
              </tr>
            </thead>
            <tbody id="notifications-table-body-user"></tbody>
          </table>
          <div id="search-logs-user-section" class="hidden mt-3">
            <h4>æ¤œç´¢ãƒ­ã‚°ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰</h4>
            <table class="table table-bordered" id="search-logs-table-user">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                  <th>æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</th>
                  <th>ãƒ’ãƒƒãƒˆä»¶æ•°</th>
                  <th>æ¤œç´¢æ—¥æ™‚</th>
                </tr>
              </thead>
              <tbody id="search-logs-table-body-user"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div id="section-account" class="section hidden">
        <h3>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†</h3>
        <form id="account-update-form">
          <div class="form-group">
            <label for="current-password">ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" class="form-control" id="current-password" required>
          </div>
          <div class="form-group">
            <label for="new-username">æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
            <input type="text" class="form-control" id="new-username">
          </div>
          <div class="form-group">
            <label for="new-password">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" class="form-control" id="new-password">
          </div>
          <div class="form-group">
            <label for="confirm-new-password">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label>
            <input type="password" class="form-control" id="confirm-new-password">
          </div>
          <button type="submit" class="btn btn-primary">æ›´æ–°ã™ã‚‹</button>
        </form>
      </div>
    </div>
  </div>

  <!-- jQuery ã¨ Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script>
    $(document).ready(function(){
      let jwtToken = "";
      let currentUserRole = "";
      let currentGenerationMode = "manual"; // å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰/ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰ã‚’ä¿æŒ

      // PDFç®¡ç†ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµã‚Šè¾¼ã¿ç”¨ã«å…¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä¿æŒ
      let allDocuments = [];

      // ----------------------------------------------------------------------
      // ç”»é¢åˆ¶å¾¡é–¢æ•°
      // ----------------------------------------------------------------------
      function showEnvSection(section) {
        $("#section-company-management, #section-notifications").addClass("hidden");
        if(section === "company"){
          $("#section-company-management").removeClass("hidden");
        } else if(section === "notifications"){
          $("#section-notifications").removeClass("hidden");
        }
      }
      function showUserSection(section) {
        $("#section-upload, #section-line-users, #section-documents, #section-notifications-user, #section-search, #section-account").addClass("hidden");
        if(section === "upload"){
          $("#section-upload").removeClass("hidden");
        } else if(section === "line"){
          $("#section-line-users").removeClass("hidden");
        } else if(section === "documents"){
          $("#section-documents").removeClass("hidden");
        } else if(section === "notifications"){
          $("#section-notifications-user").removeClass("hidden");
        } else if(section === "search"){
          $("#section-search").removeClass("hidden");
        } else if(section === "account"){
          $("#section-account").removeClass("hidden");
        }
      }

      // ----------------------------------------------------------------------
      // ãƒ­ã‚°ã‚¤ãƒ³
      // ----------------------------------------------------------------------
      $("#login-form").on("submit", function(e){
        e.preventDefault();
        const username = $("#login-username").val().trim();
        const password = $("#login-password").val().trim();
        $.ajax({
          url: "/login",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify({ username: username, password: password }),
          success: function(data){
            if(data.error){
              $("#login-result").text(data.error);
            } else {
              jwtToken = data.token || "";
              currentUserRole = data.role;
              $("#login-result").text("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼ ãƒ­ãƒ¼ãƒ«: " + data.role);
              $("#login-section").addClass("hidden");
              // ä¼šç¤¾åãƒ»ä¼šç¤¾ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Œã°ã€ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«è¡¨ç¤º
              if(data.company_name && data.company_code){
                $("#user-company-info").text(`${data.company_name} (${data.company_code})`);
              }

              if(currentUserRole === "env"){
                $("#env-app-section").removeClass("hidden");
                showEnvSection("company");
                loadCompanies(); // ä¼æ¥­ä¸€è¦§ã‚’è‡ªå‹•èª­ã¿è¾¼ã¿
              } else {
                $("#user-app-section").removeClass("hidden");
                showUserSection("upload"); // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»é¢ã‚’åˆæœŸè¡¨ç¤º
              }
            }
          },
          error: function(xhr){
            console.error("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:", xhr);
            $("#login-result").text("ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }
        });
      });

      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      $("#env-logout, #user-logout").on("click", function(){
        $.ajax({
          url: "/logout",
          type: "POST",
          headers: { "Authorization": "Bearer " + jwtToken },
          success: function(data){
            alert(data.message);
            jwtToken = "";
            currentUserRole = "";
            $("#env-app-section, #user-app-section").addClass("hidden");
            $("#login-section").removeClass("hidden");
          },
          error: function(xhr){
            console.error("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:", xhr);
          }
        });
      });

      // ----------------------------------------------------------------------
      // ENVãƒ¡ãƒ‹ãƒ¥ãƒ¼
      // ----------------------------------------------------------------------
      $("#nav-company-management").on("click", function(){
        showEnvSection("company");
        loadCompanies();
      });
      // ã‚µã‚¤ãƒ‰ãƒãƒ¼é€šçŸ¥ä¸€è¦§ãƒœã‚¿ãƒ³ã¯å‰Šé™¤æ¸ˆã¿
      $("#load-companies-btn").on("click", function(){
        loadCompanies();
      });

      // ä¼æ¥­ä¸€è¦§å–å¾— â†’ ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
      function loadCompanies(){
        $.ajax({
          url: "/companies/list",
          type: "GET",
          headers: { "Authorization": "Bearer " + jwtToken },
          success: function(data){
            const tbody = $("#company-table-body");
            tbody.empty();
            if(data.companies && data.companies.length > 0){
              data.companies.forEach(function(c){
                const tr = $("<tr></tr>");
                tr.append("<td>"+c.id+"</td>");
                tr.append("<td>"+c.name+"</td>");
                tr.append("<td>"+c.login_code+"</td>");
                tr.append("<td>"+(c.created_at||"")+"</td>");
                tr.append("<td>"+(c.subscription_end||"æœªè¨­å®š")+"</td>");

                // æ“ä½œåˆ—: ã‚µãƒ–ã‚¹ã‚¯å»¶é•·ã€å‰Šé™¤ã€PWãƒªã‚»ãƒƒãƒˆã€ç·¨é›†ãƒœã‚¿ãƒ³
                tr.append(`
                  <td>
                    <button class="btn btn-sm btn-warning" onclick="updateSubscription(${c.id})">
                      ã‚µãƒ–ã‚¹ã‚¯å»¶é•·
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteCompany(${c.id})">
                      å‰Šé™¤
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="resetCompanyPassword(${c.id})">
                      PWãƒªã‚»ãƒƒãƒˆ
                    </button>
                    <button class="btn btn-sm btn-info" onclick="editCompanyInfo(${c.id})">
                      ç·¨é›†
                    </button>
                  </td>
                `);
                tbody.append(tr);
              });
            } else {
              tbody.html("<tr><td colspan='6' class='text-center'>ä¼æ¥­ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>");
            }
          },
          error: function(xhr){
            console.error("ä¼æ¥­ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:", xhr);
          }
        });
      }

      // æ–°è¦ä¼æ¥­è¿½åŠ 
      $("#company-add-form").on("submit", function(e){
        e.preventDefault();
        const name = $("#company-name").val().trim();
        $.ajax({
          url: "/companies/add",
          type: "POST",
          headers: { "Authorization": "Bearer " + jwtToken },
          contentType: "application/json",
          data: JSON.stringify({ name: name }),
          success: function(data){
            alert(data.message || data.error);
            loadCompanies();
          },
          error: function(xhr){
            console.error("ä¼æ¥­è¿½åŠ ã‚¨ãƒ©ãƒ¼:", xhr);
          }
        });
      });

      // ã‚µãƒ–ã‚¹ã‚¯å»¶é•·ãƒœã‚¿ãƒ³
      window.updateSubscription = function(companyId) {
        if(!confirm("ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’30æ—¥å»¶é•·ã—ã¾ã™ã‹ï¼Ÿ")) return;
        $.ajax({
          url: `/companies/${companyId}/update_subscription`,
          type: "POST",
          headers: { "Authorization": "Bearer " + jwtToken },
          success: function(data){
            alert(data.message);
            loadCompanies();
          },
          error: function(xhr){
            console.error("ã‚µãƒ–ã‚¹ã‚¯å»¶é•·ã‚¨ãƒ©ãƒ¼:", xhr);
            alert("ã‚µãƒ–ã‚¹ã‚¯å»¶é•·ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }
        });
      };

      // ä¼æ¥­å‰Šé™¤ãƒœã‚¿ãƒ³
      window.deleteCompany = function(companyId) {
        if(!confirm("æœ¬å½“ã«ã“ã®ä¼æ¥­ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        $.ajax({
          url: `/companies/${companyId}/delete`,
          type: "POST",
          headers: { "Authorization": "Bearer " + jwtToken },
          success: function(data){
            alert(data.message);
            loadCompanies();
          },
          error: function(xhr){
            console.error("ä¼æ¥­å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", xhr);
            alert("ä¼æ¥­å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }
        });
      };

      // PWãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
      window.resetCompanyPassword = function(companyId) {
        const newPw = prompt("æ–°ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        if(!newPw) return;
        $.ajax({
          url: `/companies/${companyId}/update`,
          type: "POST",
          headers: { "Authorization": "Bearer " + jwtToken },
          contentType: "application/json",
          data: JSON.stringify({ password: newPw }),
          success: function(data){
            alert(data.message);
          },
          error: function(xhr){
            console.error("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:", xhr);
            alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ");
          }
        });
      };

      // ä¼æ¥­ç·¨é›†ãƒœã‚¿ãƒ³
      window.editCompanyInfo = function(companyId) {
        const newCompanyName = prompt("æ–°ã—ã„ä¼æ¥­å (ç©ºæ¬„ã®å ´åˆã¯å¤‰æ›´ãªã—)");
        const newUserName = prompt("æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼å (ç©ºæ¬„ã®å ´åˆã¯å¤‰æ›´ãªã—)");
        const newPassword = prompt("æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (ç©ºæ¬„ã®å ´åˆã¯å¤‰æ›´ãªã—)");

        const updateData = {};
        if(newCompanyName) {
          updateData.name = newCompanyName;
        }
        if(newUserName) {
          updateData.user_name = newUserName;
        }
        if(newPassword) {
          updateData.password = newPassword;
        }

        $.ajax({
          url: `/companies/${companyId}/update`,
          type: "POST",
          headers: { "Authorization": "Bearer " + jwtToken },
          contentType: "application/json",
          data: JSON.stringify(updateData),
          success: function(data){
            alert(data.message);
            loadCompanies();
          },
          error: function(xhr){
            console.error("ä¼æ¥­ç·¨é›†ã‚¨ãƒ©ãƒ¼:", xhr);
            alert("ä¼æ¥­æƒ…å ±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }
        });
      };

      // ENVç”¨ é€šçŸ¥ä¸€è¦§ãƒ­ãƒ¼ãƒ€ï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ã¯å‰Šé™¤ï¼‰
      function loadNotifications(role){
        $.ajax({
          url: "/notifications",
          type: "GET",
          headers: { "Authorization": "Bearer " + jwtToken },
          success: function(data){
            if(role === "env"){
              const ntBody = $("#notifications-table-body");
              ntBody.empty();
              if(data.notifications && data.notifications.length>0){
                data.notifications.forEach(function(n){
                  const tr = $("<tr></tr>");
                  tr.append("<td>"+n.id+"</td>");
                  tr.append("<td>"+n.message+"</td>");
                  tr.append("<td>"+n.created_at+"</td>");
                  tr.append("<td>"+(n.read_flag?"æ—¢èª­":"æœªèª­")+"</td>");
                  ntBody.append(tr);
                });
              } else {
                ntBody.html("<tr><td colspan='4' class='text-center'>é€šçŸ¥ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>");
              }
              const slogBody = $("#search-logs-table-body");
              slogBody.empty();
              if(data.search_logs && data.search_logs.length>0){
                data.search_logs.forEach(function(sl){
                  const tr = $("<tr></tr>");
                  tr.append("<td>"+sl.search_id+"</td>");
                  tr.append("<td>"+sl.line_display_name+"</td>");
                  tr.append("<td>"+sl.keyword+"</td>");
                  tr.append("<td>"+sl.found_count+"</td>");
                  tr.append("<td>"+sl.searched_at+"</td>");
                  slogBody.append(tr);
                });
              } else {
                slogBody.html("<tr><td colspan='5' class='text-center'>æ¤œç´¢ãƒ­ã‚°ãªã—</td></tr>");
              }
            }
          },
          error: function(xhr){
            console.error("é€šçŸ¥å–å¾—ã‚¨ãƒ©ãƒ¼:", xhr);
          }
        });
      }
      $("#load-notifications-btn").on("click", function(){
        loadNotifications("env");
      });

      // ----------------------------------------------------------------------
      // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šãƒ¡ãƒ‹ãƒ¥ãƒ¼
      // ----------------------------------------------------------------------
      $("#nav-user-upload").on("click", function(){ showUserSection("upload"); });
      $("#nav-line-users").on("click", function(){
        showUserSection("line");
        loadLineUsers();
      });
      $("#nav-documents").on("click", function(){
        showUserSection("documents");
        loadDocuments();
      });
      $("#nav-account").on("click", function(){
        showUserSection("account");
      });

      // ----------------------------------------------------------------------
      // LINEãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
      // ----------------------------------------------------------------------
      $("#load-line-users-btn").on("click", function(){
        loadLineUsers();
      });
      function loadLineUsers(){
        $.ajax({
          url: "/line/users",
          type: "GET",
          headers: { "Authorization": "Bearer " + jwtToken },
          success: function(data){
            const tbody = $("#line-users-table-body");
            tbody.empty();
            if(data.users && data.users.length > 0){
              data.users.forEach(function(u){
                const tr = $("<tr></tr>");
                tr.append("<td>"+u.id+"</td>");
                tr.append("<td>"+(u.line_display_name||"")+"</td>");
                tr.append("<td>"+(u.department||"")+"</td>");
                tr.append("<td>"+(u.is_blocked?"ãƒ–ãƒ­ãƒƒã‚¯ä¸­":"æœ‰åŠ¹")+"</td>");
                tr.append("<td>"+(u.created_at||"")+"</td>");
                tr.append(`
                  <td>
                    <button class="btn btn-sm btn-danger" onclick="blockLineUser(${u.id})">ãƒ–ãƒ­ãƒƒã‚¯</button>
                    <button class="btn btn-sm btn-success" onclick="unblockLineUser(${u.id})">è§£é™¤</button>
                  </td>
                `);
                tbody.append(tr);
              });
            } else {
              tbody.html("<tr><td colspan='6' class='text-center'>ç™»éŒ²ã•ã‚ŒãŸLINEãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“ã€‚</td></tr>");
            }
          },
          error: function(xhr){
            console.error("LINEãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:", xhr);
          }
        });
      }
      window.blockLineUser = function(uid){
        $.ajax({
          url: "/line/users/"+uid+"/block",
          type: "POST",
          headers: { "Authorization": "Bearer " + jwtToken },
          success: function(data){
            alert(data.message);
            loadLineUsers();
          },
          error: function(xhr){
            console.error("ãƒ–ãƒ­ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:", xhr);
          }
        });
      };
      window.unblockLineUser = function(uid){
        $.ajax({
          url: "/line/users/"+uid+"/unblock",
          type: "POST",
          headers: { "Authorization": "Bearer " + jwtToken },
          success: function(data){
            alert(data.message);
            loadLineUsers();
          },
          error: function(xhr){
            console.error("ãƒ–ãƒ­ãƒƒã‚¯è§£é™¤ã‚¨ãƒ©ãƒ¼:", xhr);
          }
        });
      };
      window.approveLineUser = function(uid){
        $.ajax({
          url: "/line/users/"+uid+"/approve",
          type: "POST",
          headers: { "Authorization": "Bearer " + jwtToken },
          success: function(data){
            alert(data.message);
            loadLineUsers();
          },
          error: function(xhr){
            console.error("æ‰¿èªã‚¨ãƒ©ãƒ¼:", xhr);
          }
        });
      };

      // ----------------------------------------------------------------------
      // PDFç®¡ç†ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµã‚Šè¾¼ã¿ï¼‰
      // ----------------------------------------------------------------------
      function loadDocuments(){
        $.ajax({
          url: "/documents/list",
          type: "GET",
          headers: { "Authorization": "Bearer " + jwtToken },
          success: function(data){
            allDocuments = data.documents || [];
            renderDocuments(allDocuments);
          },
          error: function(xhr){
            console.error("PDFä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:", xhr);
          }
        });
      }
      $("#load-documents-btn").on("click", function(){ loadDocuments(); });

      // ä¸€è¦§è¡¨ç¤ºç”¨ã®å…±é€šæç”»é–¢æ•°
      function renderDocuments(docs){
        const tbody = $("#documents-table-body");
        tbody.empty();
        if(docs.length > 0){
          docs.forEach(function(doc){
            const tr = $("<tr></tr>");
            tr.append("<td>"+doc.id+"</td>");
            tr.append("<td>"+doc.title+"</td>");
            tr.append("<td>"+doc.category+"</td>");
            tr.append("<td>"+(doc.created_at||"")+"</td>");
            // ã€Œç·¨é›†ã€â†’ Cloudinary PDF ã‚’æ–°ã‚¿ãƒ–ã§é–‹ã
            tr.append(`
              <td>
                <button class="btn btn-sm btn-primary" onclick="openDocInNewTab(${doc.id})">ç·¨é›†</button>
                <button class="btn btn-sm btn-danger" onclick="deleteDoc(${doc.id})">å‰Šé™¤</button>
              </td>
            `);
            tbody.append(tr);
          });
        } else {
          tbody.html("<tr><td colspan='5' class='text-center'>PDFãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>");
        }
      }

      // æ–°è¦PDFã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      $("#document-upload-form").on("submit", function(e){
        e.preventDefault();
        const formData = new FormData(this);
        $.ajax({
          url: "/documents/upload",
          type: "POST",
          headers: { "Authorization": "Bearer " + jwtToken },
          data: formData,
          processData: false,
          contentType: false,
          success: function(data){
            $("#doc-upload-result").text(data.message || data.error);
            loadDocuments();
          },
          error: function(xhr){
            console.error("PDFã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:", xhr);
            $("#doc-upload-result").text("PDFã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }
        });
      });

      // PDFå‰Šé™¤ãƒœã‚¿ãƒ³
      window.deleteDoc = function(docId) {
        if(!confirm("ã“ã®PDFã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
        $.ajax({
          url: "/documents/" + docId + "/delete",
          type: "POST",
          headers: { "Authorization": "Bearer " + jwtToken },
          success: function(data){
            alert(data.message);
            loadDocuments();
          },
          error: function(xhr){
            console.error("PDFå‰Šé™¤ã‚¨ãƒ©ãƒ¼:", xhr);
            alert("PDFã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }
        });
      };

// ã€Œç·¨é›†ã€ãƒœã‚¿ãƒ³ â†’ Cloudinary PDF ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
window.openDocInNewTab = function(docId) {
  const previewUrl = `/documents/${docId}/inline_proxy`;
  console.log("ğŸ“„ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URL:", previewUrl);
  window.open(previewUrl, "_blank");
};



      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµã‚Šè¾¼ã¿
      $("#search-keyword").on("input", function(){
        const keyword = $(this).val().trim().toLowerCase();
        if(!keyword){
          renderDocuments(allDocuments);
          return;
        }
        // ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚«ãƒ†ã‚´ãƒªã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã‚‹ã‚‚ã®ã‚’çµã‚Šè¾¼ã¿
        const filtered = allDocuments.filter(doc => {
          const t = (doc.title || "").toLowerCase();
          const c = (doc.category || "").toLowerCase();
          return t.includes(keyword) || c.includes(keyword);
        });
        renderDocuments(filtered);
      });

      // ----------------------------------------------------------------------
      // å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      // ----------------------------------------------------------------------
      function pollVideoStatus(videoId, interval = 5000, maxAttempts = 60) {
        let attempts = 0;
        const poller = setInterval(function () {
          attempts++;
          $.ajax({
            url: "/videos/" + videoId + "/view",
            type: "GET",
            headers: { Authorization: "Bearer " + jwtToken },
            success: function (data) {
              console.log("ãƒãƒ¼ãƒªãƒ³ã‚°çµæœ:", data);
              if (
                data.summary_text !== "è¦ç´„ãŒã‚ã‚Šã¾ã›ã‚“" ||
                data.quiz_text !== "ã‚¯ã‚¤ã‚ºãŒã‚ã‚Šã¾ã›ã‚“"
              ) {
                clearInterval(poller);
                $("#upload-result").text("å‹•ç”»è§£æå®Œäº†ï¼");
                $("#generated-content").val(
                  "è¦ç´„: " + (data.summary_text || "ï¼ˆè¦ç´„ãªã—ï¼‰") +
                  "\n\nã‚¯ã‚¤ã‚º: " + (data.quiz_text || "ï¼ˆã‚¯ã‚¤ã‚ºãªã—ï¼‰")
                );
              }
            },
            error: function (xhr) {
              console.error("ãƒãƒ¼ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:", xhr);
            }
          });
          if (attempts >= maxAttempts) {
            clearInterval(poller);
            $("#upload-result").text("è§£æã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã¦ã„ã¾ã™ã€‚å¾Œã»ã©å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
          }
        }, interval);
      }

      $("input[name='generation_mode']").on("change", function(){
        currentGenerationMode = $(this).val(); // "manual" or "minutes"
      });

      $("#video-file").on("change", function(){
        const file = this.files[0];
        if(file){
          const url = URL.createObjectURL(file);
          $("#video-preview").attr("src", url).removeClass("d-none");
          $("#captured-frames").empty().append('<p class="text-center">ã“ã“ã«ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„</p>');
        }
      });

      $("#capture-btn").on("click", function(){
        const video = document.getElementById("video-preview");
        if(video.paused){
          alert("å‹•ç”»ã‚’å†ç”Ÿä¸­ã«ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(function(blob){
          addCaptureImage(blob);
        }, "image/jpeg");
      });

      $("#captured-frames").on("dragover", function(e){
        e.preventDefault();
      });
      $("#captured-frames").on("drop", function(e){
        e.preventDefault();
        const files = e.originalEvent.dataTransfer.files;
        for(let i=0; i<files.length; i++){
          if(files[i].type.startsWith("image/")){
            addCaptureImage(files[i]);
          }
        }
      });

      let capturedImages = [];
      function addCaptureImage(blob){
        capturedImages.push(blob);
        renderCapturedFrames();
      }
      function renderCapturedFrames(){
        $("#captured-frames").empty();
        capturedImages.forEach((blob, idx)=>{
          const url = URL.createObjectURL(blob);
          const item = $(`
            <div class="capture-item">
              <img src="${url}" alt="ã‚­ãƒ£ãƒ—ãƒãƒ£${idx}">
              <button class="delete-capture" data-idx="${idx}">Ã—</button>
            </div>
          `);
          $("#captured-frames").append(item);
        });
      }
      $("#captured-frames").on("click", ".delete-capture", function(){
        const idx = $(this).data("idx");
        capturedImages.splice(idx, 1);
        renderCapturedFrames();
      });

      $("#video-upload-form").on("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        formData.append("generation_mode", currentGenerationMode);

        capturedImages.forEach((blob, idx) => {
          formData.append("image_files", blob, "capture_" + idx + ".jpg");
        });

        $.ajax({
          url: "/videos/upload",
          type: "POST",
          headers: { "Authorization": "Bearer " + jwtToken },
          data: formData,
          processData: false,
          contentType: false,
          timeout: 180000,
          success: function(data) {
            console.log("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹:", data);
            if (data.error) {
              $("#upload-result").text(data.error);
              return;
            }
            $("#upload-result").text("å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼ è§£æã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...");
            if (data.video_id) {
              pollVideoStatus(data.video_id);
            } else {
              console.error("video_id ãŒãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å­˜åœ¨ã—ã¾ã›ã‚“ã€‚");
            }
            $("#generation-results").removeClass("hidden");
            if (data.result) {
              $("#generated-content").val(
                "è¦ç´„: " + data.result.summary_text + "\n\nã‚¯ã‚¤ã‚º: " + data.result.quiz_text
              );
            }
          },
          error: function(xhr) {
            console.error("å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:", xhr);
            $("#upload-result").text("å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }
        });
      });

      // ----------------------------------------------------------------------
      // ç”Ÿæˆå†…å®¹ãƒ†ã‚­ã‚¹ãƒˆã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—: ç”»åƒã‚’Base64åŸ‹ã‚è¾¼ã¿
      // ----------------------------------------------------------------------
      $("#generated-content").on("dragover", function(e){
        e.preventDefault();
      });
      $("#generated-content").on("drop", function(e){
        e.preventDefault();
        const files = e.originalEvent.dataTransfer.files;
        if(files.length > 0){
          for(let i = 0; i < files.length; i++){
            if(files[i].type.startsWith("image/")){
              embedImageInTextArea(files[i]);
            }
          }
        }
      });
      function embedImageInTextArea(file){
        const reader = new FileReader();
        reader.onload = function(evt){
          const base64 = evt.target.result;
          const textarea = document.getElementById("generated-content");
          const currentVal = textarea.value;
          const imgTag = `\n<img src="${base64}" alt="EmbeddedImage">\n`;
          const startPos = textarea.selectionStart;
          const endPos = textarea.selectionEnd;
          const newVal = currentVal.substring(0, startPos)
                        + imgTag
                        + currentVal.substring(endPos);
          textarea.value = newVal;
        };
        reader.readAsDataURL(file);
      }

      // ----------------------------------------------------------------------
      // PDFåŒ–ãƒœã‚¿ãƒ³: /documents/publish ã« generation_mode ã‚‚é€ã‚‹
      // ----------------------------------------------------------------------
      $("#pdf-convert-btn").on("click", function(){
        const title = prompt("PDFã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "æ–°è¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ");
        if(!title) return;

        const content = $("#generated-content").val().trim();
        if(!content){
          alert("ç”Ÿæˆå†…å®¹ãŒç©ºã§ã™ã€‚");
          return;
        }

        $.ajax({
          url: "/documents/publish",
          type: "POST",
          headers: { "Authorization": "Bearer " + jwtToken },
          data: {
            title: title,
            content: content,
            generation_mode: currentGenerationMode
          },
          success: function(data){
            if(data.error){
              alert(data.error);
            } else {
              alert(data.message);
              loadDocuments(); // æ–°ã—ãç”Ÿæˆã•ã‚ŒãŸPDFã‚’ä¸€è¦§ã«åæ˜ 
            }
          },
          error: function(xhr){
            console.error("PDFç™ºè¡Œã‚¨ãƒ©ãƒ¼:", xhr);
            alert("PDFç™ºè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ");
          }
        });
      });

      // ----------------------------------------------------------------------
      // é€šçŸ¥ãƒ»æ¤œç´¢ãƒ­ã‚°ï¼ˆä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ï¼‰
      // ----------------------------------------------------------------------
      function loadNotificationsForUser(){
        $.ajax({
          url: "/notifications",
          type: "GET",
          headers: { "Authorization": "Bearer " + jwtToken },
          success: function(data){
            const ntBody = $("#notifications-table-body-user");
            ntBody.empty();
            if(data.notifications && data.notifications.length>0){
              data.notifications.forEach(function(n){
                const tr = $("<tr></tr>");
                tr.append("<td>"+n.id+"</td>");
                tr.append("<td>"+n.message+"</td>");
                tr.append("<td>"+n.created_at+"</td>");
                tr.append("<td>"+(n.read_flag?"æ—¢èª­":"æœªèª­")+"</td>");
                ntBody.append(tr);
              });
            } else {
              ntBody.html("<tr><td colspan='4' class='text-center'>é€šçŸ¥ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>");
            }
            // admin ã®å ´åˆã¯ search_logs ã‚‚è¡¨ç¤º
            if(currentUserRole === "admin"){
              $("#search-logs-user-section").removeClass("hidden");
              const slogBody = $("#search-logs-table-body-user");
              slogBody.empty();
              if(data.search_logs && data.search_logs.length>0){
                data.search_logs.forEach(function(sl){
                  const tr = $("<tr></tr>");
                  tr.append("<td>"+sl.search_id+"</td>");
                  tr.append("<td>"+sl.line_display_name+"</td>");
                  tr.append("<td>"+sl.keyword+"</td>");
                  tr.append("<td>"+sl.found_count+"</td>");
                  tr.append("<td>"+sl.searched_at+"</td>");
                  slogBody.append(tr);
                });
              } else {
                slogBody.html("<tr><td colspan='5' class='text-center'>æ¤œç´¢ãƒ­ã‚°ãªã—</td></tr>");
              }
            }
          },
          error: function(xhr){
            console.error("é€šçŸ¥å–å¾—ã‚¨ãƒ©ãƒ¼:", xhr);
          }
        });
      }
      $("#load-notifications-btn-user").on("click", function(){
        loadNotificationsForUser();
      });

      // ----------------------------------------------------------------------
      // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†
      // ----------------------------------------------------------------------
      $("#account-update-form").on("submit", function(e){
        e.preventDefault();
        const currentPassword = $("#current-password").val().trim();
        const newUsername = $("#new-username").val().trim();
        const newPassword = $("#new-password").val().trim();
        const confirmNewPassword = $("#confirm-new-password").val().trim();

        if(newPassword && (newPassword !== confirmNewPassword)){
          alert("æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ç¢ºèªç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚");
          return;
        }

        $.ajax({
          url: "/account/update",
          type: "POST",
          headers: { "Authorization": "Bearer " + jwtToken },
          data: {
            current_password: currentPassword,
            new_username: newUsername,
            new_password: newPassword
          },
          success: function(data){
            if(data.error){
              alert(data.error);
            } else {
              alert(data.message);
            }
          },
          error: function(xhr){
            console.error("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:", xhr);
            alert("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }
        });
      });
    });

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ãŒã€ä¸Šæ›¸ãå›é¿ç”¨ã®ãƒ€ãƒŸãƒ¼å®šç¾©
    window.blockLineUser = window.blockLineUser || function(){};
    window.unblockLineUser = window.unblockLineUser || function(){};
    window.approveLineUser = window.approveLineUser || function(){};
  </script>
</body>
</html>
